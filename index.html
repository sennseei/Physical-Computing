<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë‚˜ì˜ ì›¹(2370068, ì •ì„¸ì¸)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font:16px/1.4 system-ui, sans-serif; padding:20px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; max-width:520px; }
    .row { display:flex; gap:8px; align-items:baseline; }
    .v { font-size:28px; font-weight:700; }
    #raw { white-space:pre-wrap; background:#f6f8fa; padding:8px; border-radius:8px; }
    .ok { color:#2e7d32; } .err { color:#c62828; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h3>ë‚˜ì˜ ì›¹(2370068, ì •ì„¸ì¸)</h3>

  <div class="card">
    <div>ë¸Œë¡œì»¤: <code id="broker">wss://damoa.io:9002</code></div>
    <div>í† í”½: <code id="topic"></code></div>
    <div id="status">ì—°ê²° ëŒ€ê¸°ì¤‘â€¦</div>
    <hr/>
    <div class="row"><div>ì˜¨ë„:</div><div id="temp" class="v">--</div><div>Â°C</div></div>
    <div class="row"><div>ìŠµë„:</div><div id="humi" class="v">--</div><div>%</div></div>
    <p style="margin-top:10px">ìµœê·¼ ìˆ˜ì‹  ì›ë¬¸(JSON/í…ìŠ¤íŠ¸)</p>
    <pre id="raw"></pre>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const brokerUrl = 'wss://damoa.io:9002';   // ë¸Œë¼ìš°ì €ìš© WSS(WebSocket Secure) í¬íŠ¸
    const topic = 'ewha/2370068';              // â† ê³¼ì œ 4ë‹¨ê³„ì—ì„œ ë³¸ì¸ í•™ë²ˆìœ¼ë¡œ ìœ ì§€/ìˆ˜ì •
    document.getElementById('topic').textContent = topic;

    // ê³ ìœ  í´ë¼ì´ì–¸íŠ¸ ID
    const clientId = 'iot-client-' + Math.random().toString(16).slice(2, 10);
    const client = mqtt.connect(brokerUrl, { clientId });

    // UI ì—˜ë¦¬ë¨¼íŠ¸
    const $status = document.getElementById('status');
    const $temp = document.getElementById('temp');
    const $humi = document.getElementById('humi');
    const $raw = document.getElementById('raw');

    console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl})ì— ì ‘ì† ì‹œë„â€¦`);

    // ì ‘ì† ì„±ê³µ
    client.on('connect', () => {
      console.log(`âœ… ì ‘ì† ì„±ê³µ (id=${clientId})`);
      $status.innerHTML = `<span class="ok">ì—°ê²°ë¨</span>`;

      // ë³¸ì¸ í† í”½ êµ¬ë…
      client.subscribe(topic, (err) => {
        if (err) {
          console.error('êµ¬ë… ì˜¤ë¥˜:', err);
          $status.innerHTML = `<span class="err">êµ¬ë… ì˜¤ë¥˜</span>`;
          return;
        }
        console.log(`ğŸ“„ êµ¬ë… ì„±ê³µ: ${topic}`);

        // âœ… ìµœì´ˆ ì ‘ì† ì²´í¬ì¸: ê°™ì€ í† í”½ìœ¼ë¡œ 1íšŒ JSON ì „ì†¡ (ê³¼ì œ ìš”ê±´)
        const checkin = {
          source: "web",
          event: "checkin",
          name: "ì •ì„¸ì¸",
          id: "2370068",
          ts: new Date().toISOString()
        };
        client.publish(topic, JSON.stringify(checkin));
      });
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹  â†’ í™”ë©´ ê°±ì‹ 
    client.on('message', (_topic, message) => {
      const text = message.toString();
      console.log(_topic, text);
      $raw.textContent = text; // ì›ë¬¸ í•­ìƒ í‘œì‹œ

      // JSONì´ë©´ ì˜¨/ìŠµë„ í•„ë“œë§Œ ë½‘ì•„ í‘œì‹œ
      try {
        const data = JSON.parse(text);
        if (typeof data.temp !== "undefined") $temp.textContent = data.temp;
        if (typeof data.humi !== "undefined") $humi.textContent = data.humi;
      } catch(e) {
        // JSON ì•„ë‹ˆë©´(í…ìŠ¤íŠ¸) ìˆ«ìì¹¸ì€ ê·¸ëŒ€ë¡œ ë‘ê³  ì›ë¬¸ë§Œ ê°±ì‹ 
      }
    });

    client.on('reconnect', () => { $status.textContent = 'ì¬ì—°ê²° ì‹œë„ì¤‘â€¦'; });
    client.on('error', (err) => {
      console.error('ì—°ê²° ì˜¤ë¥˜:', err);
      $status.innerHTML = `<span class="err">ì—°ê²° ì˜¤ë¥˜</span>`;
    });
    client.on('close', () => { $status.textContent = 'ì—°ê²° ì¢…ë£Œ'; });
  </script>
</body>
</html>
